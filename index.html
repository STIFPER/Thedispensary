<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>THE DISPENSARY - Flower Menu</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1d1e1e">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
            mont: ['Montserrat', 'sans-serif'],
          },
          animation: {
            fadeIn: 'fadeIn 0.2s ease-out',
            toastIn: 'toastIn 0.3s ease-out',
            slideIn: 'slideIn 0.3s ease-out',
            bounceScale: 'bounceScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0', transform: 'scale(0.98)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
            toastIn: { '0%': { opacity: '0', transform: 'translateY(10px) translateX(-50%)' }, '100%': { opacity: '1', transform: 'translateY(0) translateX(-50%)' } },
            slideIn: { '0%': { opacity: '0', transform: 'translateX(-10px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
            bounceScale: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.3)' }, '100%': { transform: 'scale(1)' } }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #1d1e1e; color: white; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1d1e1e; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .cart-item-enter { animation: slideIn 0.3s ease-out; }
  </style>
</head>

<body class="antialiased selection:bg-[#a0d4b2] selection:text-black font-inter">
  <!-- ✅ Navbar mount -->
  <div id="navbar"></div>

  <!-- ✅ React root (มีอันเดียวพอ) -->
  <div id="root"></div>

  <!-- ✅ Load navbar -->
  <script src="navbar-loader.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const X = ({ size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
      </svg>
    );
    const ShoppingBag = ({ size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/>
      </svg>
    );
    const Trash2 = ({ size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
      </svg>
    );
    const Plus = ({ size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M5 12h14"/><path d="M12 5v14"/>
      </svg>
    );
    const Minus = ({ size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M5 12h14"/>
      </svg>
    );
    const Check = ({ size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    );
    const Camera = ({ size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>
      </svg>
    );

    const terpeneColors = {
      'myrcene': '#2b398c', 'caryophyllene': '#77823d', 'humulene': '#fd8b03',
      'limonene': '#7bc70f', 'ocimene': '#009282', 'phellandrene': '#fd0106',
      'pinene': '#08a152', 'terpinolene': '#4b5e3d', 'terpineol': '#ee5a29',
      'linalool': '#9094d8', 'bisabolol': '#e6c122',
    };

const [menu, setMenu] = useState({ meta: {}, products: [], preRolls: [] });
const [menuError, setMenuError] = useState("");

useEffect(() => {
  fetch('./menu.json?v=' + Date.now())
    .then(r => {
      if (!r.ok) throw new Error("menu.json not found: " + r.status);
      return r.json();
    })
    .then(data => {
      setMenu(data);
      setMenuError("");
    })
    .catch(err => {
      setMenuError(String(err));
      setMenu({ meta: {}, products: [], preRolls: [] });
    });
}, []);

const products = menu.products || [];
const preRolls = menu.preRolls || [];


    const TerpeneBadge = ({ name }) => {
      const key = name.split(' ')[0].toLowerCase().trim();
      const color = terpeneColors[key] || '#4b5563';
      return (
        <span className="inline-block text-white font-mont font-bold text-[9px] px-2 py-0.5 rounded-sm mr-1 mb-1 uppercase tracking-wide shadow-sm" style={{ backgroundColor: color }}>
          {name}
        </span>
      );
    };

    const BadgeElement = ({ type, size = 'sm' }) => {
      const styles = {
        full: { size: '102px', fontNew: '22px', fontBest: '18px', fontBuy: '15px', lh: '1.1' },
        md: { size: '68px', fontNew: '15px', fontBest: '13px', fontBuy: '10px', lh: '1.1' },
        sm: { size: '52px', fontNew: '11px', fontBest: '9px', fontBuy: '8px', lh: '1.1' }
      };
      const config = styles[size];
      const boxStyle = { width: config.size, height: config.size, minWidth: config.size, minHeight: config.size };
      const clipStyle = { clipPath: 'polygon(50% 0%, 61% 10%, 75% 6%, 79% 20%, 93% 25%, 90% 39%, 100% 50%, 90% 61%, 93% 75%, 79% 80%, 75% 94%, 61% 90%, 50% 100%, 39% 90%, 25% 94%, 21% 80%, 7% 75%, 10% 61%, 0% 50%, 10% 39%, 7% 25%, 21% 20%, 25% 6%, 39% 10%)' };

      let content = null;
      let bgClass = '';

      if (type === 'NEW') {
        bgClass = 'bg-[#A4F21E]';
        content = <span style={{fontSize: config.fontNew}}>NEW</span>;
      } else if (type === 'BEST SELLER') {
        bgClass = 'bg-[#FFC107]';
        content = <><span style={{fontSize: config.fontBest, lineHeight: config.lh}}>BEST</span><span style={{fontSize: config.fontBest, lineHeight: config.lh}}>SELLER</span></>;
      } else if (type === 'BUY 1' || (type && type.includes('BUY 1'))) {
        bgClass = 'bg-[#E61633]';
        content = <><span style={{fontSize: config.fontBuy, lineHeight: config.lh}}>BUY 1</span><span style={{fontSize: config.fontBuy, lineHeight: config.lh}}>GET 1</span><span style={{fontSize: config.fontBuy, lineHeight: config.lh}}>FREE</span></>;
      } else if (type === 'BUY 2') {
        bgClass = 'bg-[#FF2E7E]';
        content = <><span style={{fontSize: config.fontBuy, lineHeight: config.lh}}>BUY 2</span><span style={{fontSize: config.fontBuy, lineHeight: config.lh}}>GET 1</span><span style={{fontSize: config.fontBuy, lineHeight: config.lh}}>FREE</span></>;
      }

      if (!content) return null;
      return (
        <div className={`flex flex-col justify-center items-center text-center text-white font-inter font-black shrink-0 grow-0 hover:scale-110 hover:rotate-6 transition-transform duration-200 ${bgClass}`} style={{...boxStyle, ...clipStyle}}>
          {content}
        </div>
      );
    };

    const StatusBadge = ({ tags, size = 'sm' }) => {
      const placeholderSize = size === 'sm' ? '52px' : size === 'md' ? '68px' : '102px';
      const containerStyle = { width: placeholderSize, minWidth: placeholderSize };

      if (!tags || tags.length === 0) {
        return <div style={containerStyle} className="mr-2 shrink-0"></div>;
      }
      const tag = tags[0];
      let type = '';
      if (tag === 'NEW') type = 'NEW';
      else if (tag === 'BEST SELLER') type = 'BEST SELLER';
      else if (tag.includes('BUY 1')) type = 'BUY 1';

      if (type) {
        return (
          <div className="flex items-center justify-center mr-2 shrink-0" style={containerStyle}>
            <BadgeElement type={type} size={size} />
          </div>
        );
      }
      return <div style={containerStyle} className="mr-2 shrink-0"></div>;
    };

    const ProductCard = ({ product, onClick }) => (
      <div
        onClick={() => { onClick(product); }}
        className="group cursor-pointer py-3 px-2 hover:bg-white/5 transition-all duration-200 flex items-center justify-between border-b border-gray-700/50 last:border-0"
      >
        <div className="flex items-center flex-1 pr-2">
          <StatusBadge tags={product.tags} size="sm" />
          <div className="flex flex-col justify-center">
            <h3 className="font-inter font-black text-white text-base md:text-lg uppercase leading-tight group-hover:text-[#a0d4b2] transition-colors mb-1">
              {product.name}
            </h3>
            <div className="flex items-center gap-3 mb-1.5">
              <span className="font-inter font-black text-white text-xs opacity-90">THC {product.thc}</span>
              <span className="font-inter font-black text-white text-xs opacity-90">CBD {product.cbd}</span>
            </div>
            <div className="flex flex-wrap gap-1">
              {product.terpenes.map((t, i) => <TerpeneBadge key={i} name={t} />)}
            </div>
          </div>
        </div>
        <div className="text-right whitespace-nowrap pl-1 self-start pt-3">
          <div className="font-inter font-black text-lg md:text-xl text-[#a0d4b2] tracking-tight">
            {product.p1} <span className="text-gray-500 text-sm align-middle mx-1 font-bold">|</span> {product.p35}
          </div>
        </div>
      </div>
    );

    const BoxHeader = ({ title, bgColor }) => (
      <div className="flex justify-between items-center px-4 py-2 border-b border-white/10" style={{ backgroundColor: bgColor }}>
        <h2 className="font-inter font-black text-xl md:text-2xl text-white uppercase tracking-tight">{title}</h2>
        <span className="font-inter font-black text-white text-xs md:text-sm opacity-90">1G | 3.5G</span>
      </div>
    );

    const WelcomeModal = ({ onClose }) => (
      <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fadeIn" onClick={() => { onClose(); }}>
        <div className="bg-[#1d1e1e]/95 border border-[#a0d4b2]/40 w-full max-w-sm rounded-2xl shadow-[0_0_40px_rgba(160,212,178,0.15)] overflow-hidden relative flex flex-col" onClick={(e)=>e.stopPropagation()}>
          <div className="absolute top-0 right-0 w-40 h-40 bg-[#a0d4b2]/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
          <div className="p-6 relative z-10">
            <div className="text-center mb-8 border-b border-white/10 pb-4">
              <h2 className="font-black text-3xl text-[#a0d4b2] uppercase tracking-tighter mb-1 leading-none">HOW TO ORDER</h2>
              <p className="text-gray-400 text-[10px] font-bold uppercase tracking-[0.2em]">Quick Guide</p>
            </div>

            <div className="space-y-6 mb-8">
              <div className="flex gap-4 items-start group">
                <div className="bg-[#a0d4b2]/10 text-[#a0d4b2] w-8 h-8 rounded-full flex items-center justify-center font-black text-sm shrink-0 border border-[#a0d4b2]/20 group-hover:bg-[#a0d4b2] group-hover:text-black transition-colors duration-300">1</div>
                <div>
                  <h3 className="font-black text-white text-sm uppercase mb-1 tracking-wide">SELECT YOUR STRAINS</h3>
                  <p className="text-gray-400 text-xs font-medium leading-relaxed">Choose your preferred flowers or pre-rolls and add them to your cart.</p>
                </div>
              </div>

              <div className="flex gap-4 items-start group">
                <div className="bg-[#a0d4b2]/10 text-[#a0d4b2] w-8 h-8 rounded-full flex items-center justify-center font-black text-sm shrink-0 border border-[#a0d4b2]/20 group-hover:bg-[#a0d4b2] group-hover:text-black transition-colors duration-300">2</div>
                <div>
                  <h3 className="font-black text-white text-sm uppercase mb-1 tracking-wide">CHECK YOUR CART</h3>
                  <p className="text-gray-400 text-xs font-medium leading-relaxed">Click the Shopping Bag icon to review your selected items.</p>
                </div>
              </div>

              <div className="flex gap-4 items-start group">
                <div className="bg-[#a0d4b2]/10 text-[#a0d4b2] w-8 h-8 rounded-full flex items-center justify-center font-black text-sm shrink-0 border border-[#a0d4b2]/20 group-hover:bg-[#a0d4b2] group-hover:text-black transition-colors duration-300">3</div>
                <div>
                  <h3 className="font-black text-white text-sm uppercase mb-1 tracking-wide">CAPTURE RECEIPT</h3>
                  <p className="text-gray-400 text-xs font-medium leading-relaxed">Screenshot your order summary from your device to send to Admin via LINE OA.</p>
                </div>
              </div>

              <div className="flex gap-4 items-start group">
                <div className="bg-[#a0d4b2]/10 text-[#a0d4b2] w-8 h-8 rounded-full flex items-center justify-center font-black text-sm shrink-0 border border-[#a0d4b2]/20 group-hover:bg-[#a0d4b2] group-hover:text-black transition-colors duration-300">4</div>
                <div>
                  <h3 className="font-black text-white text-sm uppercase mb-1 tracking-wide">SEND TO ADMIN</h3>
                  <p className="text-gray-400 text-xs font-medium leading-relaxed">Send the captured image to our Admin to verify and confirm your delivery.</p>
                </div>
              </div>
            </div>

            <button
              onClick={() => { onClose(); }}
              className="w-full bg-[#a0d4b2] hover:bg-white hover:text-black text-black font-black py-4 rounded-xl uppercase tracking-[0.15em] text-xs md:text-sm transition-all duration-300 shadow-[0_4px_20px_rgba(160,212,178,0.2)] hover:shadow-[0_4px_25px_rgba(255,255,255,0.2)] flex items-center justify-center gap-3 transform active:scale-95">
              START SHOPPING <span>→</span>
            </button>
          </div>
        </div>
      </div>
    );

    const ProductModal = ({ product, onClose, onAddToCart }) => {
      const [qty1g, setQty1g] = useState(0);
      const [qty35g, setQty35g] = useState(0);

      const handleAdd = () => {
        if (qty1g > 0 || qty35g > 0) {
          onAddToCart(product, qty1g, qty35g);
          onClose();
        }
      };

      const totalItems = qty1g + qty35g;

      return (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn" onClick={() => { onClose(); }}>
          <div className="bg-[#1d1e1e] border border-gray-700 w-full max-w-lg rounded-xl relative shadow-2xl overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            <div className="relative bg-gradient-to-r from-gray-900 to-[#1d1e1e] p-6 border-b border-gray-800">
              <button onClick={() => { onClose(); }} className="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10 p-1 bg-black/20 rounded-full">
                <X size={20} />
              </button>
              <div className="flex justify-between items-start gap-4">
                <div className="flex-1">
                  <p className="font-bold text-gray-500 text-xs uppercase tracking-[0.2em] mb-2">{product.cat === 'COMPOUND' ? 'COMPOUND GENETICS' : product.cat}</p>
                  <h2 className="font-black text-3xl md:text-4xl text-[#a0d4b2] uppercase leading-none mb-3 tracking-tight">{product.name}</h2>
                  <div className="flex items-center gap-3">
                    <span className="bg-[#a0d4b2]/10 text-[#a0d4b2] px-2 py-1 rounded text-xs font-bold border border-[#a0d4b2]/20">THC {product.thc}</span>
                    {product.cbd !== '0%' && <span className="bg-gray-700/50 text-gray-300 px-2 py-1 rounded text-xs font-bold border border-gray-600">CBD {product.cbd}</span>}
                  </div>
                </div>
                <div className="pt-1"><StatusBadge tags={product.tags} size="md" /></div>
              </div>
            </div>

            <div className="p-6 space-y-6 bg-[#1d1e1e]">
              <div className="space-y-3">
                <div className={`flex items-center justify-between p-3 rounded-lg border ${qty1g > 0 ? 'border-[#a0d4b2] bg-[#a0d4b2]/5' : 'border-white/10 bg-white/5'} transition-colors`}>
                  <div>
                    <span className="block font-bold text-gray-300 text-sm uppercase">1 Gram</span>
                    <span className="block font-black text-white text-xl">{product.p1}</span>
                  </div>
                  <div className="flex items-center gap-4 bg-black/30 rounded-full p-1">
                    <button
                      onClick={() => { setQty1g(Math.max(0, qty1g - 1)); }}
                      className={`p-2 rounded-full transition-colors ${qty1g > 0 ? 'text-white hover:bg-white/10' : 'text-gray-600'}`}>
                      <Minus size={16} />
                    </button>
                    <span className={`font-black w-4 text-center ${qty1g > 0 ? 'text-[#a0d4b2]' : 'text-gray-500'}`}>{qty1g}</span>
                    <button onClick={() => { setQty1g(qty1g + 1); }} className="p-2 rounded-full text-white hover:bg-white/10 transition-colors">
                      <Plus size={16} />
                    </button>
                  </div>
                </div>

                <div className={`flex items-center justify-between p-3 rounded-lg border ${qty35g > 0 ? 'border-[#a0d4b2] bg-[#a0d4b2]/5' : 'border-white/10 bg-white/5'} transition-colors`}>
                  <div>
                    <span className="block font-bold text-gray-300 text-sm uppercase">3.5 Grams</span>
                    <span className="block font-black text-[#a0d4b2] text-xl">{product.p35}</span>
                  </div>
                  <div className="flex items-center gap-4 bg-black/30 rounded-full p-1">
                    <button
                      onClick={() => { setQty35g(Math.max(0, qty35g - 1)); }}
                      className={`p-2 rounded-full transition-colors ${qty35g > 0 ? 'text-white hover:bg-white/10' : 'text-gray-600'}`}>
                      <Minus size={16} />
                    </button>
                    <span className={`font-black w-4 text-center ${qty35g > 0 ? 'text-[#a0d4b2]' : 'text-gray-500'}`}>{qty35g}</span>
                    <button onClick={() => { setQty35g(qty35g + 1); }} className="p-2 rounded-full text-white hover:bg-white/10 transition-colors">
                      <Plus size={16} />
                    </button>
                  </div>
                </div>
              </div>

              <div>
                <h3 className="font-bold text-gray-400 text-xs uppercase mb-3 flex items-center">
                  <span className="w-1.5 h-1.5 rounded-full bg-[#a0d4b2] mr-2"></span>Terpene Profile
                </h3>
                <div className="flex flex-wrap gap-2">
                  {product.terpenes.map((t, i) => (
                    <span key={i} className="bg-gray-800 border border-gray-700 text-gray-300 font-mont font-bold text-[10px] md:text-xs px-3 py-1.5 rounded-md uppercase shadow-sm flex items-center">{t}</span>
                  ))}
                </div>
              </div>

              <button onClick={handleAdd} disabled={totalItems === 0}
                className={`w-full font-black py-4 uppercase rounded-lg transition-all duration-300 tracking-wide text-sm shadow-lg flex items-center justify-center gap-2
                  ${totalItems > 0 ? 'bg-white hover:bg-[#a0d4b2] text-black hover:text-black hover:shadow-[#a0d4b2]/20' : 'bg-gray-800 text-gray-500 cursor-not-allowed border border-gray-700'}`}>
                {totalItems > 0 ? `Add to Cart (${totalItems})` : 'Select Quantity'}
              </button>
            </div>
          </div>
        </div>
      );
    };
const App = () => {
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [cart, setCart] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [notification, setNotification] = useState(null);
  const [cartBump, setCartBump] = useState(false);
  const [showWelcome, setShowWelcome] = useState(false);
  const cartReady = useRef(false);

  // ✅ MENU LOAD (ONE SOURCE ONLY)
  const [menu, setMenu] = useState({ meta: {}, products: [], preRolls: [] });
  const [menuError, setMenuError] = useState("");

  useEffect(() => {
    fetch('./menu.json?v=' + Date.now())
      .then(r => {
        if (!r.ok) throw new Error("menu.json not found: " + r.status);
        return r.json();
      })
      .then(data => {
        setMenu(data);
        setMenuError("");
      })
      .catch(err => {
        setMenuError(String(err));
        setMenu({ meta: {}, products: [], preRolls: [] });
      });
  }, []);

  const products = menu.products || [];
  const preRolls = menu.preRolls || [];

  // ✅ Load cart from session
  useEffect(() => {
    try {
      const saved = JSON.parse(sessionStorage.getItem("cart_v1") || "[]");
      if (Array.isArray(saved)) setCart(saved);
    } catch {}
    cartReady.current = true;
  }, []);

  useEffect(() => {
    if (!cartReady.current) return;
    try {
      sessionStorage.setItem("cart_v1", JSON.stringify(cart));
    } catch {}
    window.dispatchEvent(new Event("cart:updated"));
  }, [cart]);

  useEffect(() => {
    const open = () => setIsCartOpen(true);
    window.addEventListener("cart:open", open);
    return () => window.removeEventListener("cart:open", open);
  }, []);

  useEffect(() => {
    const key = "openCartOnLoad_v1";
    if (sessionStorage.getItem(key) === "1") {
      sessionStorage.removeItem(key);
      setIsCartOpen(true);
    }
  }, []);

  useEffect(() => {
    const hasSeenGuide = sessionStorage.getItem('hasSeenGuide_v1');
    if (!hasSeenGuide) {
      const timer = setTimeout(() => setShowWelcome(true), 500);
      sessionStorage.setItem('hasSeenGuide_v1', 'true');
      return () => clearTimeout(timer);
    }
  }, []);

  useEffect(() => {
        if (!cartReady.current) return;
        try {
          sessionStorage.setItem("cart_v1", JSON.stringify(cart));
        } catch {}
        window.dispatchEvent(new Event("cart:updated"));
      }, [cart]);

      useEffect(() => {
        const open = () => { setIsCartOpen(true); };
        window.addEventListener("cart:open", open);
        return () => window.removeEventListener("cart:open", open);
      }, []);

      useEffect(() => {
        const key = "openCartOnLoad_v1";
        if (sessionStorage.getItem(key) === "1") {
          sessionStorage.removeItem(key);
          setIsCartOpen(true);
        }
      }, []);

      useEffect(() => {
        const hasSeenGuide = sessionStorage.getItem('hasSeenGuide_v1');
        if (!hasSeenGuide) {
          const timer = setTimeout(() => setShowWelcome(true), 500);
          sessionStorage.setItem('hasSeenGuide_v1', 'true');
          return () => clearTimeout(timer);
        }
      }, []);

      const handleBatchAddToCart = (product, qty1, qty35) => {
        let newItems = [];
        let promoText = '';
        let tags = product.tags || [];

        if (tags.length > 0) {
          const tag = tags[0];
          if (tag.includes('BUY 1')) promoText = 'BUY 1 GET 1 FREE';
          else if (tag.includes('BUY 2')) promoText = 'BUY 2 GET 1 FREE';
        }

        const base = Date.now();
        for (let i = 0; i < qty1; i++) newItems.push({ id: base + i, name: product.name, size: '1G', price: product.p1, promo: promoText, tags: tags });
        for (let i = 0; i < qty35; i++) newItems.push({ id: base + qty1 + i + 1000, name: product.name, size: '3.5G', price: product.p35, promo: promoText, tags: tags });

        setCart(prev => [...prev, ...newItems]);

        const totalAdded = qty1 + qty35;
        setNotification(`ADDED: ${product.name} (${totalAdded} ITEMS)`);
        setCartBump(true);

        if (window.notifyTimer) clearTimeout(window.notifyTimer);
        if (window.bumpTimer) clearTimeout(window.bumpTimer);
        window.notifyTimer = setTimeout(() => setNotification(null), 2500);
        window.bumpTimer = setTimeout(() => setCartBump(false), 300);
      };

      const addSingleToCart = (product, size, price, e) => {
        if (e) e.stopPropagation();

        let promoText = '';
        if (size === 'JOINT') promoText = 'BUY 2 GET 1 FREE';

        const newItem = { id: Date.now() + Math.floor(Math.random() * 999), name: product.name, size, price, promo: promoText, tags: product.tags || [] };
        setCart(prev => [...prev, newItem]);

        setNotification(`ADDED: ${product.name} (${size})`);
        setCartBump(true);

        if (window.notifyTimer) clearTimeout(window.notifyTimer);
        if (window.bumpTimer) clearTimeout(window.bumpTimer);
        window.notifyTimer = setTimeout(() => setNotification(null), 2500);
        window.bumpTimer = setTimeout(() => setCartBump(false), 300);
      };

      const removeFromCart = (id) => { setCart(cart.filter(item => item.id !== id)); };
      const clearCart = () => { setCart([]); };

      const totalGrams = cart.reduce((sum, item) => {
        if (item.size === '1G') return sum + 1;
        if (item.size === '3.5G') return sum + 3.5;
        return sum;
      }, 0);

      const totalJoints = cart.reduce((sum, item) => (item.size === 'JOINT' ? sum + 1 : sum), 0);

      const groupedCart = cart.reduce((acc, item) => {
        if (!acc[item.name]) acc[item.name] = { name: item.name, tags: item.tags, items: [] };
        acc[item.name].items.push(item);
        return acc;
      }, {});

      const sativa = products.filter(p => p.cat === 'SATIVA');
      const indica = products.filter(p => p.cat === 'INDICA');
      const hybrid = products.filter(p => p.cat === 'HYBRID');
      const cbd = products.filter(p => p.cat === 'CBD');
      const compound = products.filter(p => p.cat === 'COMPOUND');

      return (
  <div className="min-h-screen flex flex-col pb-10 bg-[#1d1e1e] text-white">

    {menuError && (
      <div className="max-w-[1400px] mx-auto w-full px-4 py-3 mb-4 bg-red-500/20 border border-red-500 text-red-200 text-sm">
        MENU ERROR: {menuError}
      </div>
    )}

    {notification && (
            <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-[#a0d4b2] text-black px-4 py-3 rounded shadow-2xl z-[100] flex items-center gap-3 animate-toastIn border border-white/20">
              <div className="bg-black/10 p-1.5 rounded-full shrink-0"><Check size={16} /></div>
              <div>
                <span className="block font-black text-[10px] uppercase tracking-wider opacity-60">ADDED TO CART</span>
                <span className="block font-bold text-xs uppercase leading-none">{notification}</span>
              </div>
            </div>
          )}

          <header className="max-w-[1400px] mx-auto w-full px-4 pt-8 pb-6 text-center flex flex-col items-center">
            <h2 className="font-black text-2xl text-white uppercase tracking-wider opacity-80 mb-2">THE DISPENSARY</h2>
            <h1 className="font-black text-[40px] md:text-5xl text-[#a0d4b2] uppercase leading-none tracking-tight mb-2">FLOWER MENU</h1>
            <p className="font-black text-lg text-white uppercase tracking-[0.2em] mb-8">
  {menu.meta?.monthLabel || "MENU"}
</p>

            <div className="border-t border-b border-gray-600 py-4 grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 text-xs font-inter uppercase tracking-wide text-gray-400 w-full max-w-4xl">
              <div><strong className="block text-white mb-1 text-sm font-black">TRUSTED QUALITY</strong>HAND-TRIMMED, LAB-TESTED</div>
              <div className="md:border-x border-gray-600"><strong className="block text-white mb-1 text-sm font-black">GACP CERTIFIED</strong>MEDICAL STANDARDS COMPLIANT</div>
              <div><strong className="block text-white mb-1 text-sm font-black">PRESCRIPTION AVAILABLE</strong>DOCTOR'S PRESCRIPTIONS IN-STORE</div>
            </div>
          </header>

          <main className="flex flex-col md:flex-row gap-6 max-w-[1400px] mx-auto w-full px-4">
            <div className="contents md:flex md:flex-col md:w-1/2 md:gap-6">
              <div className="order-1 border border-white/20 rounded-sm overflow-hidden flex flex-col bg-white/[0.01]">
                <BoxHeader title="SATIVA" bgColor="#9e9e5e" />
                <div className="p-2 space-y-1">
                  {sativa.map((p, idx) => <ProductCard key={idx} product={p} onClick={setSelectedProduct} />)}
                </div>
              </div>

              <div className="order-4 border border-white/20 rounded-sm overflow-hidden bg-white/[0.01]">
                <BoxHeader title="CBD" bgColor="#9e5e97" />
                <div className="p-2">
                  {cbd.map((p, idx) => <ProductCard key={idx} product={p} onClick={setSelectedProduct} />)}
                </div>
              </div>

              <div className="order-6 border border-white/20 rounded-sm overflow-hidden bg-white/[0.01] flex flex-col flex-1">
                <div className="flex justify-between items-center px-4 py-3 border-b border-white/20 bg-[#1d1e1e]">
                  <h2 className="font-black text-2xl md:text-3xl text-[#a0d4b2] uppercase">PRE-ROLLS</h2>
                  <div className="font-black text-xl md:text-2xl text-white">550/JOINT</div>
                </div>
                <div className="p-4 flex flex-col flex-1">
                  <div className="flex justify-end mb-2"><BadgeElement type="BUY 2" size="md" /></div>
                  <div className="grid grid-cols-2 gap-2 content-center flex-1">
                    {preRolls.map((name, i) => (
                      <button
                        key={i}
                        onClick={(e) => addSingleToCart({ name: name }, 'JOINT', 550, e)}
                        className="group relative bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#a0d4b2] p-2 rounded flex items-center justify-between transition-all active:scale-95 active:bg-[#a0d4b2]/20 text-left h-full"
                      >
                        <div className="flex items-center min-w-0 flex-1 pr-2">
                          <span className="text-[#a0d4b2] mr-2 text-xs shrink-0">●</span>
                          <span className="font-black text-[10px] md:text-xs text-white uppercase tracking-wide leading-tight">{name}</span>
                        </div>
                        <div className="bg-[#1d1e1e] p-1 rounded text-[#a0d4b2] group-hover:bg-[#a0d4b2] group-hover:text-black transition-colors shrink-0 border border-[#a0d4b2]/20 group-hover:border-transparent">
                          <Plus size={14} />
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
                <div className="px-4 pb-2 text-center text-[10px] text-gray-500 font-bold uppercase">(CLICK STRAIN TO ADD • ROLLING SERVICE AVAILABLE)</div>
              </div>
            </div>

            <div className="contents md:flex md:flex-col md:w-1/2 md:gap-6">
              <div className="order-2 border border-white/20 rounded-sm overflow-hidden bg-white/[0.01]">
                <BoxHeader title="INDICA" bgColor="#158cab" />
                <div className="p-2 space-y-1">
                  {indica.map((p, idx) => <ProductCard key={idx} product={p} onClick={setSelectedProduct} />)}
                </div>
              </div>

              <div className="order-3 border border-white/20 rounded-sm overflow-hidden bg-white/[0.01]">
                <BoxHeader title="HYBRID" bgColor="#797a72" />
                <div className="p-2 space-y-1">
                  {hybrid.map((p, idx) => <ProductCard key={idx} product={p} onClick={setSelectedProduct} />)}
                </div>
              </div>

              <div className="order-5 border border-blue-900/60 rounded-sm overflow-hidden bg-[#0a101f] relative flex flex-col">
                <div className="absolute inset-0 opacity-10 pointer-events-none" style={{backgroundImage: 'radial-gradient(circle, #333 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                <div className="flex justify-between items-center px-4 py-3 border-b border-blue-900/40 relative z-10 bg-[#0a101f]/80 backdrop-blur-sm">
                  <h2 className="font-black text-xl md:text-2xl text-white uppercase tracking-tight">COMPOUND GENETICS</h2>
                  <span className="font-black text-white text-xs md:text-sm opacity-80">1G | 3.5G</span>
                </div>
                <div className="p-2 space-y-1 relative z-10 flex-1">
                  {compound.map((p, idx) => <ProductCard key={idx} product={p} onClick={setSelectedProduct} />)}
                </div>
              </div>
            </div>
          </main>

          {selectedProduct && (
            <ProductModal
              product={selectedProduct}
              onClose={() => setSelectedProduct(null)}
              onAddToCart={handleBatchAddToCart}
            />
          )}

          {showWelcome && <WelcomeModal onClose={() => setShowWelcome(false)} />}

          {isCartOpen && (
            <div className="fixed inset-0 bg-black/90 z-[60] overflow-y-auto backdrop-blur-sm animate-fadeIn" onClick={() => { setIsCartOpen(false); }}>
              <div className="min-h-full flex items-center justify-center p-4">
                <div className="bg-[#1d1e1e] border-2 border-[#a0d4b2] w-full max-w-md relative shadow-2xl flex flex-col my-8" onClick={(e) => e.stopPropagation()}>
                  <div className="bg-[#a0d4b2] p-4 pb-5 flex flex-col gap-3 text-black shrink-0 relative">
                    <div className="flex justify-between items-start">
                      <div>
                        <h2 className="font-black text-2xl uppercase tracking-tight leading-none">ORDER SUMMARY</h2>
                        <p className="font-bold text-[10px] uppercase opacity-60 tracking-widest">Verify your items below</p>
                      </div>
                      <div className="flex items-center gap-2">
                        {cart.length > 0 && (
                          <button onClick={() => { clearCart(); }}
                            className="bg-red-500/20 hover:bg-red-500 hover:text-white p-2 rounded-full transition-colors mr-1" title="Clear Order">
                            <Trash2 size={20} className="text-black hover:text-white" />
                          </button>
                        )}
                        <button onClick={() => { setIsCartOpen(false); }} className="bg-black/10 hover:bg-black/20 p-2 rounded-full transition-colors">
                          <X size={20} className="text-black" />
                        </button>
                      </div>
                    </div>

                    <div className="bg-[#1d1e1e] rounded-lg py-2 px-4 flex items-center justify-center gap-4 border border-black/20 shadow-md">
                      <div className="flex items-center gap-2 border-r border-[#a0d4b2]/20 pr-4">
                        <Camera size={14} className="text-[#a0d4b2]" />
                        <span className="font-black text-[10px] uppercase tracking-widest text-[#a0d4b2]">CHECKOUT:</span>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="flex items-center gap-1.5">
                          <span className="bg-[#a0d4b2] text-black w-4 h-4 rounded-full flex items-center justify-center font-black text-[9px] shadow-sm leading-none pt-[1px]">1</span>
                          <span className="font-bold text-[9px] uppercase tracking-wide text-[#a0d4b2]">Screenshot</span>
                        </div>
                        <div className="flex items-center gap-1.5">
                          <span className="bg-[#a0d4b2] text-black w-4 h-4 rounded-full flex items-center justify-center font-black text-[9px] shadow-sm leading-none pt-[1px]">2</span>
                          <span className="font-bold text-[9px] uppercase tracking-wide text-[#a0d4b2]">Send Admin</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="p-4 space-y-4 bg-[#1d1e1e]">
                    {cart.length === 0 ? (
                      <div className="text-center py-10 text-gray-500 font-bold uppercase tracking-wide">Your cart is empty</div>
                    ) : (
                      Object.values(groupedCart).map((group, idx) => (
                        <div key={idx} className="bg-white/5 border border-white/10 p-3 cart-item-enter relative group flex flex-col gap-2">
                          <div className="flex justify-between items-center border-b border-white/10 pb-2">
                            <span className="font-black text-[#a0d4b2] text-lg uppercase tracking-tight">{group.name}</span>
                            <div className="scale-75 origin-right"><StatusBadge tags={group.tags} size="sm" /></div>
                          </div>
                          <div className="flex flex-col gap-2">
                            {group.items.map((item) => (
                              <div key={item.id} className="flex justify-between items-start pl-2 border-l-2 border-[#a0d4b2]/30">
                                <div className="flex flex-col">
                                  <div className="flex items-center gap-2">
                                    <span className="font-bold text-black bg-white text-[10px] px-1.5 rounded">{item.size}</span>
                                    <span className="text-xs text-gray-400">× 1</span>
                                  </div>
                                  {item.promo && (
                                    <div className="inline-block px-1.5 py-0.5 rounded-[2px] text-[8px] font-black uppercase mt-1 tracking-wide text-white w-fit"
                                      style={{backgroundColor: item.promo.includes('BUY 1') ? '#E61633' : '#FF2E7E'}}>
                                      {item.promo}
                                    </div>
                                  )}
                                </div>
                                <button onClick={() => removeFromCart(item.id)} className="text-gray-300 hover:text-red-500 p-2 transition-colors">
                                  <Trash2 size={16} />
                                </button>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))
                    )}
                  </div>

                  <div className="p-4 border-t border-gray-700 bg-black/20 shrink-0">
                    <div className="flex flex-col gap-2">
                      {totalGrams > 0 && (
                        <div className="flex justify-between items-end border-b border-gray-700/50 pb-2">
                          <span className="font-bold text-[#a0d4b2] text-sm uppercase">Total Flower</span>
                          <span className="font-black text-[#a0d4b2] text-3xl">{totalGrams} <span className="text-sm align-top text-[#a0d4b2]/70">G</span></span>
                        </div>
                      )}
                      {totalJoints > 0 && (
                        <div className="flex justify-between items-end">
                          <span className="font-bold text-[#a0d4b2] text-sm uppercase">Total Pre-rolls</span>
                          <span className="font-black text-[#a0d4b2] text-3xl">{totalJoints} <span className="text-sm align-top text-[#a0d4b2]/70">JOINTS</span></span>
                        </div>
                      )}
                      {totalGrams === 0 && totalJoints === 0 && <div className="text-center text-gray-500 text-xs italic py-2">No items selected</div>}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          <button
            onClick={() => { setIsCartOpen(true); }}
            className={`fixed bottom-6 right-6 z-[70] bg-[#1d1e1e] border border-[#a0d4b2]/40 shadow-2xl p-3 rounded-full text-white hover:text-[#a0d4b2] transition-all ${cartBump ? 'scale-125 text-[#a0d4b2]' : ''}`}
            aria-label="Open cart"
          >
            <ShoppingBag size={22} />
            {cart.length > 0 && (
              <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-[#1d1e1e]">
                {cart.length}
              </span>
            )}
          </button>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>